name: Reusable TruffleHog Secret Scan

on:
  workflow_call:
    inputs:
      fail-on-unverified:
        description: "Fail workflow on unverified secrets"
        required: false
        default: "false"
        type: string
      fail-on-verified:
        description: "Fail workflow on verified secrets"
        required: false
        default: "true"
        type: string
      scan-type:
        description: "Scan type: commits, filesystem, or both"
        required: false
        default: "filesystem"
        type: string
      scan-scope:
        description: "Scan scope: changed-files, full-repo, or both"
        required: false
        default: "full-repo"
        type: string
      trufflehog-version:
        description: "TruffleHog version to use (optional override)"
        required: false
        default: ""
        type: string
      runs-on:
        description: "The runner to use for the job"
        required: false
        default: "ubuntu-latest"
        type: string

permissions:
  contents: read
  pull-requests: write
  checks: write

env:
  TRUFFLEHOG_VERSION: "3.75.0" # ratchet:trufflesecurity/trufflehog@v3.75.0

jobs:
  trufflehog-scan:
    runs-on: ${{ inputs.runs-on }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          # Limited history to reduce credential exposure risk
          # 100 commits covers most recent development for security scanning
          fetch-depth: 100
          persist-credentials: false

      - name: Set TruffleHog version
        id: version
        env:
          INPUT_VERSION: ${{ inputs.trufflehog-version }}
          DEFAULT_VERSION: ${{ env.TRUFFLEHOG_VERSION }}
        run: |
          if [ -n "${INPUT_VERSION}" ]; then
            echo "version=${INPUT_VERSION}" >> "${GITHUB_OUTPUT}"
          else
            echo "version=v${DEFAULT_VERSION}" >> "${GITHUB_OUTPUT}"
          fi

      - name: Install TruffleHog
        run: |
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh \
            | sh -s -- -b /usr/local/bin "${{ steps.version.outputs.version }}"
          trufflehog --version


      - name: Identify changed files in pull request for targeted scanning
        id: changed-files
        if: github.event_name == 'pull_request'
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.sha }}
        run: |
          git diff --name-only "${BASE_SHA}..${HEAD_SHA}" > changed-files.txt
          echo "Changed files in this PR:"
          cat changed-files.txt || echo "No files changed"

      - name: Scan for secrets using TruffleHog
        id: scan
        run: |
          set +e

          # Simple, aggressive scan - no filtering, no complexity
          echo "Running TruffleHog filesystem scan..."
          trufflehog filesystem . --json --no-update > scan-results.json || true

          # Count results
          if [[ -s scan-results.json ]]; then
            # Convert NDJSON to array and count
            jq -s '.' scan-results.json > all-results.json 2>/dev/null || echo "[]" > all-results.json
            VERIFIED=$(jq '[.[] | select(.Verified==true)] | length' all-results.json 2>/dev/null || echo "0")
            UNVERIFIED=$(jq '[.[] | select(.Verified==false)] | length' all-results.json 2>/dev/null || echo "0")
          else
            echo "[]" > all-results.json
            VERIFIED=0
            UNVERIFIED=0
          fi

          TOTAL=$((VERIFIED+UNVERIFIED))

          echo "Scan Summary:"
          echo "Verified secrets: ${VERIFIED}"
          echo "Unverified secrets: ${UNVERIFIED}"
          echo "Total findings: ${TOTAL}"

          # Show raw results for debugging
          echo "Raw scan results:"
          cat scan-results.json || echo "No raw results"

          {
            echo "verified=${VERIFIED}"
            echo "unverified=${UNVERIFIED}"
            echo "total=${TOTAL}"
          } >> "${GITHUB_OUTPUT}"

      - name: Hide/minimize previous TruffleHog scan result comments on PR
        if: ${{ !cancelled() && github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository }}
        id: hide-comments
        uses: int128/hide-comment-action@a30d551065e4231e6d7a671bb5ce884f9ee6417b # v1.43.0
        with:
          ends-with: "<!-- trufflehog-secret-scan-comment -->"

      - name: Generate formatted scan results for PR comment (verified/unverified secrets)
        if: ${{ !cancelled() && github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository }}
        id: comment-body
        run: |
          if [[ ! -f "all-results.json" || ! -s "all-results.json" ]]; then
            echo "No results file found"
            {
              echo 'body<<EOF'
              echo '**TruffleHog Scan Results**'
              echo ''
              echo 'No secrets detected in this PR.'
              echo 'EOF'
            } >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Parse results with error handling
          if jq empty all-results.json 2>/dev/null; then
            VERIFIED=$(jq '[.[] | select(.Verified==true)] | length' all-results.json 2>/dev/null || echo "0")
            UNVERIFIED=$(jq '[.[] | select(.Verified==false)] | length' all-results.json 2>/dev/null || echo "0")
          else
            echo "Invalid JSON in all-results.json for PR comment"
            VERIFIED=0
            UNVERIFIED=0
          fi
          TOTAL=$((VERIFIED+UNVERIFIED))

          if [[ $TOTAL -eq 0 ]]; then
            {
              echo 'body<<EOF'
              echo '**TruffleHog Scan Results**'
              echo ''
              echo 'No secrets detected in this PR.'
              echo 'EOF'
            } >> "$GITHUB_OUTPUT"
          else
            # Generate findings list with error handling
            FINDINGS=$(jq -r '.[] |
              "- " +
              (if .Verified then "**VERIFIED SECRET**" else "**Possible secret**" end) +
              " (" + .DetectorName + ") at `" +
              ((.SourceMetadata?.Data?.Filesystem?.file // .SourceMetadata?.Data?.Git?.file) // "unknown") +
              ":" +
              ((.SourceMetadata?.Data?.Filesystem?.line // .SourceMetadata?.Data?.Git?.line) | tostring) +
              "` → `" +
              (if (.Raw | length) > 8 then (.Raw[:4] + "***" + .Raw[-4:]) else "***" end) +
              "`"' all-results.json 2>/dev/null || echo "- Error processing scan results")

            ACTION_TEXT=""
            if [[ $VERIFIED -gt 0 ]]; then
              ACTION_TEXT="**ACTION REQUIRED:** Rotate verified credentials immediately."
            else
              ACTION_TEXT="**Review:** Check if unverified secrets are false positives."
            fi

            {
              echo 'body<<EOF'
              echo "**TruffleHog Scan Results**"
              echo ''
              echo "**Summary:** Found ${TOTAL} potential secrets (${VERIFIED} verified, ${UNVERIFIED} unverified)"
              echo ''
              echo "${FINDINGS}"
              echo ''
              echo "${ACTION_TEXT}"
              echo 'EOF'
            } >> "$GITHUB_OUTPUT"
          fi

      - name: Post TruffleHog scan results as PR comment
        if: ${{ !cancelled() && github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository }}
        uses: int128/comment-action@f4faf53666ef83da7d274fa2007e9212c4d719c3 # v1.39.0
        with:
          post: |
            ${{ steps.comment-body.outputs.body }}
            <!-- trufflehog-secret-scan-comment -->


      - name: Create TruffleHog scan artifact
        env:
          REPOSITORY: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          COMMIT: ${{ github.sha }}
          TOTAL_SECRETS: ${{ steps.scan.outputs.total }}
          VERIFIED_SECRETS: ${{ steps.scan.outputs.verified }}
          UNVERIFIED_SECRETS: ${{ steps.scan.outputs.unverified }}
        run: |
          # Create a comprehensive scan report
          {
            echo "TruffleHog Scan Report"
            echo "====================="
            echo "Scan Date: $(date)"
            echo "Repository: ${REPOSITORY}"
            echo "Branch: ${BRANCH}"
            echo "Commit: ${COMMIT}"
            echo ""
            echo "Summary:"
            echo "- Total secrets found: ${TOTAL_SECRETS}"
            echo "- Verified secrets: ${VERIFIED_SECRETS}"
            echo "- Unverified secrets: ${UNVERIFIED_SECRETS}"
            echo ""
            echo "Detailed Results:"
            echo "=================="
            if [[ -f "all-results.json" && -s "all-results.json" ]] && jq empty all-results.json 2>/dev/null; then
              jq -r '.[] | "- " + (if .Verified then "VERIFIED" else "Unverified" end) + " " + .DetectorName + " at " + ((.SourceMetadata?.Data?.Filesystem?.file // .SourceMetadata?.Data?.Git?.file) // "unknown") + ":" + ((.SourceMetadata?.Data?.Filesystem?.line // .SourceMetadata?.Data?.Git?.line) | tostring) + " → " + (if (.Raw | length) > 8 then (.Raw[:4] + "***" + .Raw[-4:]) else "***" end)' all-results.json 2>/dev/null || echo "Error processing detailed results"
            else
              echo "No secrets detected"
            fi
          } > trufflehog_scan.txt

      - name: Upload TruffleHog scan results as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trufflehog_scan
          path: trufflehog_scan.txt
          retention-days: 30

      - name: Fail workflow based on secret detection policy (verified/unverified thresholds)
        env:
          VERIFIED_COUNT: ${{ steps.scan.outputs.verified }}
          UNVERIFIED_COUNT: ${{ steps.scan.outputs.unverified }}
          FAIL_ON_VERIFIED: ${{ inputs.fail-on-verified }}
          FAIL_ON_UNVERIFIED: ${{ inputs.fail-on-unverified }}
        run: |
          SHOULD_FAIL=false

          if [[ "${FAIL_ON_VERIFIED}" == "true" && "${VERIFIED_COUNT}" != "0" ]]; then
            SHOULD_FAIL=true
          fi

          if [[ "${FAIL_ON_UNVERIFIED}" == "true" && "${UNVERIFIED_COUNT}" != "0" ]]; then
            SHOULD_FAIL=true
          fi

          if [[ "${SHOULD_FAIL}" == "true" ]]; then
            echo "Workflow failed due to secrets found"
            echo "Verified secrets: ${VERIFIED_COUNT}"
            echo "Unverified secrets: ${UNVERIFIED_COUNT}"
            exit 1
          else
            echo "No action needed - secrets found but within configured thresholds"
          fi
